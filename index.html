<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asthma Risk Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes shake {
            0%, 100% { transform: translateX(-50%) rotate(0deg); }
            25% { transform: translateX(-50%) rotate(-2deg); }
            75% { transform: translateX(-50%) rotate(2deg); }
        }
        
        .alert-banner {
            animation: shake 0.5s;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-600 via-purple-600 to-purple-700 p-5">
    <div id="alertBanner" class="alert-banner fixed top-5 left-1/2 -translate-x-1/2 bg-red-600 text-white px-10 py-5 rounded-xl text-xl font-bold shadow-2xl z-50 hidden"></div>
    
    <div class="max-w-7xl mx-auto">
        <h1 class="text-center text-white text-4xl md:text-5xl font-bold mb-8 drop-shadow-lg">Asthma Risk Monitoring Dashboard</h1>
        
        <div class="text-center mb-8 space-x-2 md:space-x-4">
            <button onclick="window.location.href='history.html'" class="bg-white text-indigo-600 px-4 md:px-6 py-3 rounded-lg font-semibold shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all duration-300">View History & Trends</button>
            <button onclick="testSound()" class="bg-white text-indigo-600 px-4 md:px-6 py-3 rounded-lg font-semibold shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all duration-300">Test Alert Sound</button>
            <button id="toggleSound" onclick="toggleSoundNotifications()" class="bg-white text-indigo-600 px-4 md:px-6 py-3 rounded-lg font-semibold shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all duration-300"><span id="soundIcon">ðŸ”Š</span> <span id="soundText">ON</span></button>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Physiological Panel -->
            <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 transition-all duration-300 hover:-translate-y-2 hover:shadow-3xl">
                <h2 class="text-2xl md:text-3xl font-bold mb-6 text-gray-800 border-b-4 border-indigo-500 pb-3">Health Monitoring</h2>
                
                <h3 class="text-lg md:text-xl font-semibold mb-4 text-gray-700">Vital Signs</h3>
                <div class="space-y-3 mb-6">
                    <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                        <span class="font-semibold text-gray-600">Blood Oxygen (SpO2)</span>
                        <span class="text-xl font-bold text-gray-900" id="spo2">--</span>
                    </div>
                    <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                        <span class="font-semibold text-gray-600">Heart Rate</span>
                        <span class="text-xl font-bold text-gray-900" id="heartRate">--</span>
                    </div>
                    <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                        <span class="font-semibold text-gray-600">Breathing Rate</span>
                        <span class="text-xl font-bold text-gray-900" id="breathingRate">--</span>
                    </div>
                    <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                        <span class="font-semibold text-gray-600">Respiratory Sounds</span>
                        <span class="text-xl font-bold text-gray-900" id="audioDetection">--</span>
                    </div>
                </div>
                
                <h3 class="text-lg md:text-xl font-semibold mb-4 text-gray-700">Health Status</h3>
                <div class="text-center my-5">
                    <span class="risk-badge inline-block px-6 py-2 rounded-full font-bold text-lg uppercase" id="physioRisk">--</span>
                </div>
                <div class="mt-4">
                    <strong class="text-gray-700">Detected Issues:</strong>
                    <div id="physioTriggers" class="mt-3 text-gray-500">--</div>
                </div>
            </div>
            
            <!-- Environmental Panel -->
            <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 transition-all duration-300 hover:-translate-y-2 hover:shadow-3xl">
                <h2 class="text-2xl md:text-3xl font-bold mb-6 text-gray-800 border-b-4 border-indigo-500 pb-3">Environmental Conditions</h2>
                
                <h3 class="text-lg md:text-xl font-semibold mb-4 text-gray-700">Current Measurements</h3>
                <div class="space-y-3 mb-6">
                    <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                        <span class="font-semibold text-gray-600">Temperature</span>
                        <span class="text-xl font-bold text-gray-900" id="temperature">--</span>
                    </div>
                    <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                        <span class="font-semibold text-gray-600">Humidity</span>
                        <span class="text-xl font-bold text-gray-900" id="humidity">--</span>
                    </div>
                    <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                        <span class="font-semibold text-gray-600">PM2.5</span>
                        <span class="text-xl font-bold text-gray-900" id="pm25">--</span>
                    </div>
                </div>
                
                <h3 class="text-lg md:text-xl font-semibold mb-4 text-gray-700">Environmental Status</h3>
                <div class="text-center my-5">
                    <span class="risk-badge inline-block px-6 py-2 rounded-full font-bold text-lg uppercase" id="envRisk">--</span>
                </div>
                <div class="mt-4">
                    <strong class="text-gray-700">Environmental Triggers:</strong>
                    <div id="envTriggers" class="mt-3 text-gray-500">--</div>
                </div>
            </div>
        </div>
        
        <div class="text-center text-white text-sm mt-5 opacity-90" id="lastUpdate">Last updated: --</div>
        
        <div id="loadingMessage" class="text-center text-white text-xl py-10">Loading sensor data...</div>
    </div>

    <script>
        let soundEnabled = true;
        let audioContext = null;
        let lastAlertTime = 0;

        // Initialize Audio Context
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log('AudioContext created, state:', audioContext.state);
            }
            
            if (audioContext.state === 'suspended') {
                audioContext.resume().then(() => {
                    console.log('AudioContext resumed, state:', audioContext.state);
                });
            }
        }

        // Play alert sound with beeping pattern
        async function playAlertSound() {
            if (!soundEnabled) {
                console.log('Sound notifications disabled');
                return;
            }
            
            initAudioContext();
            
            if (audioContext.state !== 'running') {
                await audioContext.resume();
                console.log('AudioContext resumed for playback');
            }
            
            console.log('Playing alert sound... AudioContext state:', audioContext.state);
            
            // Create 5 beeps
            for (let i = 0; i < 5; i++) {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800; // Higher frequency for alert
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.7, audioContext.currentTime + i * 0.3); // Louder volume
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + i * 0.3 + 0.2);
                
                oscillator.start(audioContext.currentTime + i * 0.3);
                oscillator.stop(audioContext.currentTime + i * 0.3 + 0.2);
            }
        }

        // Toggle sound notifications
        function toggleSoundNotifications() {
            soundEnabled = !soundEnabled;
            const btn = document.getElementById('toggleSound');
            const icon = document.getElementById('soundIcon');
            const text = document.getElementById('soundText');
            
            if (soundEnabled) {
                btn.className = 'bg-white text-indigo-600 px-4 md:px-6 py-3 rounded-lg font-semibold shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all duration-300';
                icon.textContent = 'ðŸ”Š';
                text.textContent = 'ON';
            } else {
                btn.className = 'bg-gray-300 text-gray-600 px-4 md:px-6 py-3 rounded-lg font-semibold shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all duration-300';
                icon.textContent = 'ðŸ”‡';
                text.textContent = 'OFF';
            }
            
            console.log('Sound notifications:', soundEnabled ? 'ENABLED' : 'DISABLED');
        }

        // Test sound function
        function testSound() {
            console.log('Testing alert sound...');
            playAlertSound();
            showAlert('This is a test alert. Sound should be playing.');
        }

        // Show alert banner
        function showAlert(message) {
            const banner = document.getElementById('alertBanner');
            banner.textContent = message;
            banner.classList.remove('hidden');
            
            setTimeout(() => {
                banner.classList.add('hidden');
            }, 5000);
        }

        // Check for high risk and alert
        function checkAndAlert(physioRisk, envRisk) {
            const now = Date.now();
            const cooldownPeriod = 60000; // 1 minute cooldown
            
            if (now - lastAlertTime < cooldownPeriod) {
                console.log('Alert in cooldown period');
                return;
            }
            
            if (physioRisk === 'high') {
                console.log('HIGH PHYSIOLOGICAL RISK DETECTED!');
                showAlert('âš ï¸ HIGH PHYSIOLOGICAL RISK DETECTED');
                playAlertSound();
                lastAlertTime = now;
            } else if (envRisk === 'high') {
                console.log('HIGH ENVIRONMENTAL RISK DETECTED!');
                showAlert('âš ï¸ HIGH ENVIRONMENTAL RISK DETECTED');
                playAlertSound();
                lastAlertTime = now;
            }
        }

        // Update display with risk data
        function updateDisplay(riskId, triggersId, risk, triggers) {
            // Update risk badge styling with Tailwind
            const riskBadge = document.getElementById(riskId);
            riskBadge.textContent = risk.toUpperCase();
            riskBadge.className = 'inline-block px-6 py-2 rounded-full font-bold text-lg uppercase';
            
            if (risk === 'safe') {
                riskBadge.classList.add('bg-green-100', 'text-green-800');
            } else if (risk === 'medium') {
                riskBadge.classList.add('bg-yellow-100', 'text-yellow-800');
            } else if (risk === 'high') {
                riskBadge.classList.add('bg-red-100', 'text-red-800');
            }
            
            // Update triggers list
            const triggersDiv = document.getElementById(triggersId);
            if (triggers && triggers.length > 0) {
                triggersDiv.innerHTML = '<ul class="list-disc list-inside space-y-1">' + 
                    triggers.map(t => `<li class="text-gray-700">${t}</li>`).join('') + 
                    '</ul>';
            } else {
                triggersDiv.innerHTML = '<span class="text-green-600">No issues detected</span>';
            }
        }

        // Fetch and update physiological assessment
        async function updatePhysiologicalAssessment() {
            try {
                const response = await fetch('/api/assess-risk', { method: 'POST' });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Physiological data:', data);
                
                // Update sensor readings
                document.getElementById('spo2').textContent = data.sensor_data.spo2 ? data.sensor_data.spo2 + '%' : '--';
                document.getElementById('heartRate').textContent = data.sensor_data.heart_rate ? data.sensor_data.heart_rate + ' bpm' : '--';
                document.getElementById('breathingRate').textContent = data.sensor_data.breathing_rate ? data.sensor_data.breathing_rate + ' bpm' : '--';
                document.getElementById('audioDetection').textContent = data.sensor_data.audio_detection || '--';
                
                // Update risk assessment
                updateDisplay('physioRisk', 'physioTriggers', data.risk, data.triggers);
                
                return data.risk;
                
            } catch (error) {
                console.error('Error fetching physiological assessment:', error);
                document.getElementById('physioRisk').textContent = 'Error';
                return null;
            }
        }

        // Fetch and update environmental assessment
        async function updateEnvironmentalAssessment() {
            try {
                const response = await fetch('/api/assess-environmental', { method: 'POST' });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Environmental data:', data);
                
                // Update environmental readings
                document.getElementById('temperature').textContent = data.sensor_data.temperature ? data.sensor_data.temperature.toFixed(1) + 'Â°C' : '--';
                document.getElementById('humidity').textContent = data.sensor_data.humidity ? data.sensor_data.humidity.toFixed(1) + '%' : '--';
                document.getElementById('pm25').textContent = data.sensor_data.pm25 ? data.sensor_data.pm25.toFixed(1) + ' Âµg/mÂ³' : '--';
                
                // Update risk assessment
                updateDisplay('envRisk', 'envTriggers', data.risk, data.triggers);
                
                return data.risk;
                
            } catch (error) {
                console.error('Error fetching environmental assessment:', error);
                document.getElementById('envRisk').textContent = 'Error';
                return null;
            }
        }

        // Update all assessments
        async function updateAllAssessments() {
            document.getElementById('loadingMessage').classList.add('hidden');
            
            const physioRisk = await updatePhysiologicalAssessment();
            const envRisk = await updateEnvironmentalAssessment();
            
            // Check for high risk and trigger alerts
            if (physioRisk && envRisk) {
                checkAndAlert(physioRisk, envRisk);
            }
            
            // Update timestamp
            const now = new Date();
            document.getElementById('lastUpdate').textContent = 
                `Last updated: ${now.toLocaleTimeString()}`;
        }

        // Initialize audio context on user interaction
        document.addEventListener('click', () => {
            initAudioContext();
        }, { once: true });

        // Initial load
        updateAllAssessments();

        // Auto-refresh every 30 seconds
        setInterval(updateAllAssessments, 30000);
    </script>
</body>
</html>
