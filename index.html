<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asthma Risk Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @keyframes shake {
            0%, 100% { transform: translateX(-50%) rotate(0deg); }
            25% { transform: translateX(-50%) rotate(-2deg); }
            75% { transform: translateX(-50%) rotate(2deg); }
        }
        
        .alert-banner {
            animation: shake 0.5s;
        }
        
        .audio-prompt {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .audio-prompt-hidden {
            display: none;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50 p-5">
    <!-- Audio Enable Prompt -->
    <div id="audioPrompt" class="audio-prompt">
        <div class="bg-white rounded-lg p-8 max-w-md text-center shadow-2xl">
            <div class="text-5xl mb-4">ðŸ””</div>
            <h2 class="text-2xl font-medium text-gray-800 mb-3">Enable Alert Notifications</h2>
            <p class="text-gray-600 mb-6">Click the button below to enable sound alerts for high-risk events</p>
            <button onclick="enableAudio()" class="bg-blue-500 hover:bg-blue-600 text-white px-8 py-3 rounded-lg text-lg font-medium transition-colors duration-200">
                Enable Alerts
            </button>
        </div>
    </div>
    
    <div id="alertBanner" class="alert-banner fixed top-5 left-1/2 -translate-x-1/2 bg-red-50 border border-red-200 text-red-700 px-10 py-4 rounded-lg text-lg font-medium shadow-lg z-50 hidden"></div>
    
    <div class="max-w-7xl mx-auto">
        <h1 class="text-center text-gray-800 text-3xl md:text-4xl font-light mb-2 tracking-tight">Asthma Risk Monitoring</h1>
        <p class="text-center text-gray-500 text-sm mb-8">Real-time health and environmental assessment</p>
        
        <div class="text-center mb-8 space-x-2 md:space-x-3">
            <button onclick="window.location.href='history.html'" class="bg-white border border-gray-200 text-gray-700 px-5 py-2 rounded-md text-sm font-medium hover:bg-gray-50 hover:border-blue-300 transition-all duration-200">History & Trends</button>
            <button onclick="testSound()" class="bg-white border border-gray-200 text-gray-700 px-5 py-2 rounded-md text-sm font-medium hover:bg-gray-50 hover:border-blue-300 transition-all duration-200">Test Alert</button>
            <button id="toggleSound" onclick="toggleSoundNotifications()" class="bg-white border border-gray-200 text-gray-700 px-5 py-2 rounded-md text-sm font-medium hover:bg-gray-50 hover:border-blue-300 transition-all duration-200"><span id="soundIcon">ðŸ”Š</span> <span id="soundText">Sound On</span></button>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-5 mb-6">
            <!-- Physiological Panel -->
            <div class="bg-white border border-gray-200 rounded-lg p-6 md:p-7">
                <h2 class="text-xl font-medium mb-5 text-gray-800 pb-2 border-b border-gray-200">Health Monitoring</h2>
                
                <div class="space-y-2 mb-6">
                    <div class="flex justify-between items-center py-3 border-b border-gray-100">
                        <span class="text-sm text-gray-600">Blood Oxygen (SpO2)</span>
                        <span class="text-lg font-medium text-gray-900" id="spo2">--</span>
                    </div>
                    <div class="flex justify-between items-center py-3 border-b border-gray-100">
                        <span class="text-sm text-gray-600">Heart Rate</span>
                        <span class="text-lg font-medium text-gray-900" id="heartRate">--</span>
                    </div>
                    <div class="flex justify-between items-center py-3 border-b border-gray-100">
                        <span class="text-sm text-gray-600">Breathing Rate</span>
                        <span class="text-lg font-medium text-gray-900" id="breathingRate">--</span>
                    </div>
                    <div class="flex justify-between items-center py-3">
                        <span class="text-sm text-gray-600">Respiratory Sounds</span>
                        <span class="text-lg font-medium text-gray-900" id="audioDetection">--</span>
                    </div>
                </div>
                
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <div class="text-center mb-5">
                        <span class="risk-badge inline-block px-5 py-1.5 rounded-md text-sm font-medium uppercase tracking-wide" id="physioRisk">--</span>
                    </div>
                    <div class="text-xs text-gray-500 uppercase tracking-wider mb-3">Detected Issues</div>
                    <div id="physioTriggers" class="text-sm text-gray-600 min-h-[20px]">--</div>
                </div>
            </div>
            
            <!-- Environmental Panel -->
            <div class="bg-white border border-gray-200 rounded-lg p-6 md:p-7">
                <h2 class="text-xl font-medium mb-5 text-gray-800 pb-2 border-b border-gray-200">Environmental Conditions</h2>
                
                <div class="space-y-2 mb-6">
                    <div class="flex justify-between items-center py-3 border-b border-gray-100">
                        <span class="text-sm text-gray-600">Temperature</span>
                        <span class="text-lg font-medium text-gray-900" id="temperature">--</span>
                    </div>
                    <div class="flex justify-between items-center py-3 border-b border-gray-100">
                        <span class="text-sm text-gray-600">Humidity</span>
                        <span class="text-lg font-medium text-gray-900" id="humidity">--</span>
                    </div>
                    <div class="flex justify-between items-center py-3">
                        <span class="text-sm text-gray-600">PM2.5</span>
                        <span class="text-lg font-medium text-gray-900" id="pm25">--</span>
                    </div>
                </div>
                
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <div class="text-center mb-5">
                        <span class="risk-badge inline-block px-5 py-1.5 rounded-md text-sm font-medium uppercase tracking-wide" id="envRisk">--</span>
                    </div>
                    <div class="text-xs text-gray-500 uppercase tracking-wider mb-3">Environmental Triggers</div>
                    <div id="envTriggers" class="text-sm text-gray-600 min-h-[20px]">--</div>
                </div>
            </div>
        </div>
        
        <div class="text-center text-gray-400 text-xs mt-5" id="lastUpdate">Last updated: --</div>
        
        <div id="loadingMessage" class="text-center text-gray-400 text-sm py-10">Loading sensor data...</div>
    </div>

    <script>
        let soundEnabled = true;
        let audioContext = null;
        let lastAlertTime = 0;
        let supabaseClient = null;
        let realtimeChannel = null;

        // Initialize Supabase client for real-time updates
        function initSupabase() {
            const SUPABASE_URL = 'https://ogapdrgcwmzecbwwrmre.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9nYXBkcmdjd216ZWNid3dybXJlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzNDIxNzAsImV4cCI6MjA3MzkxODE3MH0.5ondVqwEc09dcuO9DsFcOqVl8lctcrI4CIjmhKsua10';
            
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('Supabase client initialized for real-time updates');
            
            // Subscribe to real-time changes
            subscribeToRealtimeUpdates();
        }

        // Subscribe to Supabase real-time updates
        function subscribeToRealtimeUpdates() {
            realtimeChannel = supabaseClient
                .channel('sensor_data_changes')
                .on(
                    'postgres_changes',
                    {
                        event: 'INSERT',
                        schema: 'public',
                        table: 's3_sensor_data'
                    },
                    (payload) => {
                        console.log('New data detected in real-time!', payload);
                        // Update dashboard immediately
                        updateAllAssessments();
                    }
                )
                .subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        console.log('âœ… Real-time subscription active - dashboard will update instantly!');
                    }
                });
        }

        // Initialize Audio Context
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log('AudioContext created, state:', audioContext.state);
            }
            
            if (audioContext.state === 'suspended') {
                audioContext.resume().then(() => {
                    console.log('AudioContext resumed, state:', audioContext.state);
                });
            }
        }

        // Enable audio and hide prompt
        function enableAudio() {
            // Initialize audio context
            initAudioContext();
            
            // Play a silent sound to unlock audio
            if (audioContext) {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                gainNode.gain.setValueAtTime(0.001, audioContext.currentTime);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.01);
            }
            
            // Hide the prompt
            document.getElementById('audioPrompt').classList.add('audio-prompt-hidden');
            
            // Store preference
            localStorage.setItem('audioEnabled', 'true');
            
            console.log('âœ… Audio alerts enabled and ready!');
        }

        // Check if audio was already enabled
        function checkAudioPreference() {
            const audioEnabled = localStorage.getItem('audioEnabled');
            if (audioEnabled === 'true') {
                document.getElementById('audioPrompt').classList.add('audio-prompt-hidden');
                initAudioContext();
            }
        }

        // Play alert sound with beeping pattern
        async function playAlertSound() {
            if (!soundEnabled) {
                console.log('Sound notifications disabled');
                return;
            }
            
            initAudioContext();
            
            if (audioContext.state !== 'running') {
                await audioContext.resume();
                console.log('AudioContext resumed for playback');
            }
            
            console.log('Playing alert sound... AudioContext state:', audioContext.state);
            
            // Create 5 beeps
            for (let i = 0; i < 5; i++) {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800; // Higher frequency for alert
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.7, audioContext.currentTime + i * 0.3); // Louder volume
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + i * 0.3 + 0.2);
                
                oscillator.start(audioContext.currentTime + i * 0.3);
                oscillator.stop(audioContext.currentTime + i * 0.3 + 0.2);
            }
        }

        // Toggle sound notifications
        function toggleSoundNotifications() {
            soundEnabled = !soundEnabled;
            const btn = document.getElementById('toggleSound');
            const icon = document.getElementById('soundIcon');
            const text = document.getElementById('soundText');
            
            if (soundEnabled) {
                btn.className = 'bg-white border border-gray-200 text-gray-700 px-5 py-2 rounded-md text-sm font-medium hover:bg-gray-50 hover:border-blue-300 transition-all duration-200';
                icon.textContent = 'ðŸ”Š';
                text.textContent = 'Sound On';
            } else {
                btn.className = 'bg-white border border-gray-300 text-gray-400 px-5 py-2 rounded-md text-sm font-medium hover:bg-gray-50 transition-all duration-200';
                icon.textContent = 'ðŸ”‡';
                text.textContent = 'Sound Off';
            }
            
            console.log('Sound notifications:', soundEnabled ? 'ENABLED' : 'DISABLED');
        }

        // Test sound function
        function testSound() {
            console.log('Testing alert sound...');
            playAlertSound();
            showAlert('This is a test alert. Sound should be playing.');
        }

        // Show alert banner
        function showAlert(message) {
            const banner = document.getElementById('alertBanner');
            banner.textContent = message;
            banner.classList.remove('hidden');
            
            setTimeout(() => {
                banner.classList.add('hidden');
            }, 5000);
        }

        // Check for high risk and alert
        function checkAndAlert(physioRisk, envRisk) {
            const now = Date.now();
            const cooldownPeriod = 60000; // 1 minute cooldown
            
            if (now - lastAlertTime < cooldownPeriod) {
                console.log('Alert in cooldown period');
                return;
            }
            
            if (physioRisk === 'high') {
                console.log('HIGH PHYSIOLOGICAL RISK DETECTED!');
                showAlert('âš ï¸ HIGH PHYSIOLOGICAL RISK DETECTED');
                playAlertSound();
                lastAlertTime = now;
            } else if (envRisk === 'high') {
                console.log('HIGH ENVIRONMENTAL RISK DETECTED!');
                showAlert('âš ï¸ HIGH ENVIRONMENTAL RISK DETECTED');
                playAlertSound();
                lastAlertTime = now;
            }
        }

        // Update display with risk data
        function updateDisplay(riskId, triggersId, risk, triggers) {
            // Update risk badge styling with Tailwind - minimal colors
            const riskBadge = document.getElementById(riskId);
            riskBadge.textContent = risk.toUpperCase();
            riskBadge.className = 'inline-block px-5 py-1.5 rounded-md text-sm font-medium uppercase tracking-wide';
            
            if (risk === 'safe') {
                riskBadge.classList.add('bg-blue-50', 'text-blue-600', 'border', 'border-blue-200');
            } else if (risk === 'medium') {
                riskBadge.classList.add('bg-amber-50', 'text-amber-700', 'border', 'border-amber-200');
            } else if (risk === 'high') {
                riskBadge.classList.add('bg-red-50', 'text-red-700', 'border', 'border-red-200');
            }
            
            // Update triggers list
            const triggersDiv = document.getElementById(triggersId);
            if (triggers && triggers.length > 0) {
                triggersDiv.innerHTML = '<ul class="space-y-1">' + 
                    triggers.map(t => `<li class="text-gray-700 text-sm">â€¢ ${t}</li>`).join('') + 
                    '</ul>';
            } else {
                triggersDiv.innerHTML = '<span class="text-blue-600 text-sm">No issues detected</span>';
            }
        }

        // Fetch and update physiological assessment
        async function updatePhysiologicalAssessment() {
            try {
                const response = await fetch('/api/assess-risk', { method: 'POST' });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Physiological data:', data);
                
                // Update sensor readings
                document.getElementById('spo2').textContent = data.sensor_data.spo2 ? data.sensor_data.spo2 + '%' : '--';
                document.getElementById('heartRate').textContent = data.sensor_data.heart_rate ? data.sensor_data.heart_rate + ' bpm' : '--';
                document.getElementById('breathingRate').textContent = data.sensor_data.breathing_rate ? data.sensor_data.breathing_rate + ' bpm' : '--';
                document.getElementById('audioDetection').textContent = data.sensor_data.audio_detection || '--';
                
                // Update risk assessment
                updateDisplay('physioRisk', 'physioTriggers', data.risk, data.triggers);
                
                return data.risk;
                
            } catch (error) {
                console.error('Error fetching physiological assessment:', error);
                document.getElementById('physioRisk').textContent = 'Error';
                return null;
            }
        }

        // Fetch and update environmental assessment
        async function updateEnvironmentalAssessment() {
            try {
                const response = await fetch('/api/assess-environmental', { method: 'POST' });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Environmental data:', data);
                
                // Update environmental readings
                document.getElementById('temperature').textContent = data.sensor_data.temperature ? data.sensor_data.temperature.toFixed(1) + 'Â°C' : '--';
                document.getElementById('humidity').textContent = data.sensor_data.humidity ? data.sensor_data.humidity.toFixed(1) + '%' : '--';
                document.getElementById('pm25').textContent = data.sensor_data.pm25 ? data.sensor_data.pm25.toFixed(1) + ' Âµg/mÂ³' : '--';
                
                // Update risk assessment
                updateDisplay('envRisk', 'envTriggers', data.risk, data.triggers);
                
                return data.risk;
                
            } catch (error) {
                console.error('Error fetching environmental assessment:', error);
                document.getElementById('envRisk').textContent = 'Error';
                return null;
            }
        }

        // Update all assessments
        async function updateAllAssessments() {
            document.getElementById('loadingMessage').classList.add('hidden');
            
            const physioRisk = await updatePhysiologicalAssessment();
            const envRisk = await updateEnvironmentalAssessment();
            
            // Check for high risk and trigger alerts
            if (physioRisk && envRisk) {
                checkAndAlert(physioRisk, envRisk);
            }
            
            // Update timestamp
            const now = new Date();
            document.getElementById('lastUpdate').textContent = 
                `Last updated: ${now.toLocaleTimeString()}`;
        }

        // Check audio preference on page load
        checkAudioPreference();

        // Initialize Supabase real-time on page load
        initSupabase();

        // Initial load
        updateAllAssessments();

        // Keep the 30-second polling as backup (in case real-time fails)
        setInterval(updateAllAssessments, 30000);
    </script>
</body>
</html>
